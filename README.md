# アスベスト通報システム

## プロジェクト概要
- **名称**: アスベスト通報システム
- **目的**: 全国の市区町村のアスベスト関連問い合わせ先をAIで自動検索し、ユーザーに提供
- **主要機能**: 
  - 市区町村の簡単検索（インクリメンタルサーチ）
  - プルダウンによる都道府県・市区町村選択
  - Perplexity AIによる自動検索
  - 問い合わせ先情報の表示（電話、メール、フォーム、公式ページ）

## 公開URL
- **開発環境**: https://3000-isew77jy7wp9iattrfysr-5185f4aa.sandbox.novita.ai
- **管理画面**: https://3000-isew77jy7wp9iattrfysr-5185f4aa.sandbox.novita.ai/admin

## 主要機能

### ✅ 実装済み機能
1. **市区町村検索**
   - インクリメンタルサーチ（入力すると候補を自動表示）
   - プルダウン選択（都道府県→市区町村）
   - 全国の市区町村データに対応
   - **自動検索**：候補選択時またはプルダウン選択時に即座に検索実行
   - **都道府県全域検索** ⭐
     - 検索ボックスに「埼玉県」「北海道」などと入力すると都道府県候補を表示
     - プルダウンで都道府県を選択すると、市区町村の最初に都道府県名オプションが表示
     - 都道府県を選択すると、その都道府県の総合窓口を検索
     - 公式ページボタンは「埼玉県の公式ページを開く」のように都道府県名で表示

2. **検索履歴タブ機能** ⭐
   - 最新5件の検索履歴をタブで保存
   - タブをクリックして過去の検索結果に即座に切り替え
   - **×ボタンで個別削除可能**
   - localStorageで履歴を永続化
   - 市町村名のみをタブに表示（例：「横浜市」「本庄市」「埼玉県」「北海道」）

3. **管理画面** ⭐NEW
   - 検索ログの可視化（成功/失敗の統計）
   - 手動DB・API成功・API失敗のフィルタリング
   - 情報不完全な市町村の特定（電話/メール/フォームなし）
   - JSONエクスポート機能（失敗リストを出力）
   - ログのクリア機能

3. **問い合わせ先自動検索**
3. **問い合わせ先自動検索**
   - Perplexity AI（sonar-proモデル）による高精度検索
   - .go.jp、.lg.jpドメインに限定（公式サイトのみ）
   - 担当部署名、電話番号、メールアドレス、フォームURL、公式ページURLを自動抽出
   - 引用番号（[1]、[2]など）を自動削除
   - **問い合わせフォーム検出の強化** ⭐UPDATED
     - ページ最下部の「お問い合わせフォーム」リンクを優先検索
     - `/inquiry/`パターンに対応（北海道などで使用）
     - クエリパラメータ付きURL（`?group=XX&page=YY`）を正しく保持
     - フォームURLを直接クリック可能に

4. **メールアドレス表示**
4. **メールアドレス表示**
   - ✅ **常に表示**（見つからない場合は案内メッセージ）
   - 見つかった場合は「メールを送信」ボタンで即座にメールアプリ起動
   - 件名と本文を自動入力（市区町村、場所、詳細情報を含む）

5. **問い合わせフォーム表示**
5. **問い合わせフォーム表示** ⭐UPDATED
   - ✅ **常に表示**（見つからない場合は案内メッセージ）
   - 見つかった場合は「フォームを開く」ボタンで新しいタブで開く
   - form、inquiry、contact、otoiawase、mail などのキーワードで検出
   - **クエリパラメータ付きURLも正しく保持**（例：`?group=96&page=12399`）
   - 北海道など`/inquiry/`パターンのフォームにも対応

6. **その他の連絡先**
   - 電話番号（クリックで発信可能）
   - 公式ページへのリンク
   - AI検索結果の詳細表示

## データ構造
- **検索対象**: 全国47都道府県の市区町村データ
- **使用API**: Perplexity API（sonar-proモデル）
- **ストレージ**: 不要（APIベースの検索）

## 技術スタック
- **フレームワーク**: Hono + TypeScript
- **デプロイ**: Cloudflare Pages
- **フロントエンド**: TailwindCSS + Font Awesome
- **API**: Perplexity AI

## 開発環境

### セットアップ
```bash
npm install
npm run build
pm2 start ecosystem.config.cjs
```

### デプロイ
```bash
npm run deploy
```

### 環境変数
- `PERPLEXITY_API_KEY`: Perplexity APIキー（.dev.varsに設定済み）

## 使い方

### メイン画面
1. **市区町村を選択**
   - 方法1: 検索ボックスに市区町村名を入力して候補から選択（自動検索）
   - 方法2: プルダウンから都道府県→市区町村を選択（自動検索）
   - 方法3: **都道府県全域で検索**
     - 検索ボックスに「埼玉県」「北海道」と入力して都道府県を選択
     - プルダウンで都道府県を選択し、市区町村で都道府県名を選択

2. **検索結果を確認**
   - 担当部署名（都道府県・市町村名付き）
   - 電話番号（クリックで発信）
   - メールアドレス（クリックでメール送信）
   - 問い合わせフォーム（クリックでフォームを開く）
   - 公式ページ（都道府県検索時：「埼玉県の公式ページを開く」、市区町村検索時：「横浜市の公式ページを開く」）

3. **検索履歴タブ**
   - 最新5件の検索結果がタブで表示されます
   - タブをクリックすると過去の検索結果にすぐ戻れます
   - **×ボタンをクリックで個別に履歴を削除できます**
   - ブラウザを閉じても履歴は保存されます

### 管理画面（/admin）
1. **検索ログの確認**
   - 総検索数、成功（手動DB）、成功（API）、失敗の統計を確認
   - フィルターで特定のログを表示（すべて/手動DB/API成功/API失敗/情報不完全）
   - 検索日時、ソース、ステータス、電話/メール/フォームの有無を確認

2. **失敗した市町村の特定**
   - フィルターで「API失敗」または「情報不完全」を選択
   - 失敗した市町村のリストを確認
   - JSONエクスポートボタンで失敗リストをダウンロード

3. **手動データベースへの追加**
   - 失敗した市町村の情報を手動で調査
   - `src/index.tsx`の`manualDatabase`オブジェクトに追加
   - 再デプロイで反映

### メール送信機能
- 「メールを送信」ボタンをクリックすると、メールアプリが起動します
- 件名と本文は自動入力されます
- 本文には以下が含まれます：
  - 市区町村
  - 担当部署

### 問い合わせフォーム機能
- 「フォームを開く」ボタンをクリックすると、新しいタブで開きます
- 自治体の公式問い合わせフォームに直接アクセスできます

## デプロイ状況
- **プラットフォーム**: Cloudflare Pages（準備中）
- **ステータス**: ❌ 未デプロイ（開発環境のみ）
- **最終更新**: 2026-01-23

## 改善履歴

### 2026-01-23
- ✅ **検索ログ管理機能を追加**
  - 検索の成功/失敗を記録する仕組みを実装
  - 管理画面（/admin）を作成：統計情報、フィルタリング、JSONエクスポート
  - 手動DB・API成功・API失敗・情報不完全のフィルター機能
  - 失敗した市町村のリストを簡単に抽出可能
  - 検索ログのクリア機能
- ✅ メイン画面に管理画面へのリンクを追加

### 2026-01-23（以前）
- ✅ 担当部署の前に都道府県・市町村名を表示（例: 「埼玉県本庄市 環境課・公害対策課」）
- ✅ AIレスポンスのMarkdown太字記号（`**`）を自動削除
- ✅ AIレスポンスの引用番号（`[1]`、`[2]`など）を自動削除
- ✅ 「公式ページを開く」ボタンに市町村名を追加（例: 「横浜市の公式ページを開く」）
- ✅ 「AI検索結果の詳細を見る」セクションを削除（UIをシンプル化）
- ✅ 検索ボタンを削除し、候補選択時・プルダウン選択時に自動検索
- ✅ 検索履歴タブ機能を追加（最大5件、localStorageで永続化）
- ✅ 部署名抽出の改善（余計な説明文・ハイフン以降の文章を削除）
- ✅ 都道府県全域検索機能を追加（検索ボックス・プルダウン両方対応）
- ✅ 都道府県表示を「全域」から都道府県名のみに変更（例：「埼玉県全域」→「埼玉県」）
- ✅ 公式ページボタンのラベルを改善（都道府県検索時：「埼玉県の公式ページを開く」）
- ✅ 問い合わせフォーム検出を大幅改善
  - `/inquiry/`パターンに対応（北海道など）
  - `/cgi-bin/contacts/`パターンに対応（桐生市など）⭐NEW
  - クエリパラメータ付きURLを正しく保持
  - ページ最下部の「お問い合わせフォーム」リンクを優先検索
  - Perplexityプロンプトを強化（フォーム検索を最優先に）
  - **主要31箇所調査結果**: 北海道・桐生市のフォーム検出に成功（検出率9.7%）

### 2026-01-16
- ✅ メールアドレスを常に表示（見つからない場合は案内メッセージ）
- ✅ 問い合わせフォームを常に表示（見つからない場合は案内メッセージ）
- ✅ メール送信ボタンに件名と本文の自動入力機能を追加
- ✅ フォーム検出パターンを拡張（mail、soudan、mail_form など）
- ✅ UI改善（ボタンスタイル、説明文追加）
- ✅ Perplexityプロンプトを改善（メールとフォームの検索精度向上）
- ✅ メールアドレス検出を改善（ページ下部の「お問合せ」セクションを重点的に検索）
- ✅ メールリンクを直接デフォルトメーラーを起動するように変更（ブラウザ経由なし）
- ✅ max_tokens を 1200 に増加（より詳細な検索結果）
- ✅ 公式ドメイン（.lg.jp、.go.jp）のメールアドレスを優先
- ✅ プロンプトを改善：メールアドレスを積極的に探すように指示を強化
- ✅ 建物・場所の情報と詳細情報のフォームフィールドを削除（シンプル化）

## 今後の開発予定
- [ ] Cloudflare Pagesへの本番デプロイ
- [ ] 全国の町村データの追加（段階的に拡大）
- [ ] 失敗した市町村の手動データベース拡充
- [ ] FAX番号の表示
- [ ] タブの並び替え機能（ドラッグ&ドロップ）

## 管理者向けガイド

### 失敗した市町村を手動データベースに追加する手順
1. **管理画面でログを確認**
   - `/admin`にアクセス
   - フィルターで「API失敗」または「情報不完全」を選択
   - JSONエクスポートで失敗リストをダウンロード

2. **公式サイトで情報を手動調査**
   - 失敗した市町村の公式サイトにアクセス
   - アスベスト関連の担当部署、電話番号、メール、フォームURLを確認

3. **手動データベースに追加**
   - `src/index.tsx`を開く
   - `manualDatabase`オブジェクトに以下の形式で追加：
   ```typescript
   '都道府県市町村名': {
     department: '担当部署名',
     phone: '電話番号',
     email: 'メールアドレス',
     formUrl: '問い合わせフォームURL',
     pageUrl: '公式ページURL',
     departments: [ /* 複数部局がある場合 */ ]
   }
   ```

4. **再ビルド・デプロイ**
   ```bash
   cd /home/user/webapp && npm run build
   pm2 restart webapp
   ```
