# アスベスト通報システム

## プロジェクト概要
- **名称**: アスベスト通報システム
- **目的**: 全国の市区町村のアスベスト関連問い合わせ先をAIで自動検索し、ユーザーに提供
- **主要機能**: 
  - 市区町村の簡単検索（インクリメンタルサーチ）
  - プルダウンによる都道府県・市区町村選択
  - Perplexity AIによる自動検索
  - 問い合わせ先情報の表示（電話、メール、フォーム、公式ページ）

## 公開URL
- **開発環境**: https://3000-isew77jy7wp9iattrfysr-5185f4aa.sandbox.novita.ai

## 主要機能

### ✅ 実装済み機能
1. **市区町村検索**
   - インクリメンタルサーチ（入力すると候補を自動表示）
   - プルダウン選択（都道府県→市区町村）
   - 全国の市区町村データに対応
   - **自動検索**：候補選択時またはプルダウン選択時に即座に検索実行

2. **検索履歴タブ機能** ⭐NEW
   - 最新5件の検索履歴をタブで保存
   - タブをクリックして過去の検索結果に即座に切り替え
   - localStorageで履歴を永続化
   - 市町村名のみをタブに表示（例：「横浜市」「本庄市」）

3. **問い合わせ先自動検索**
3. **問い合わせ先自動検索**
   - Perplexity AI（sonar-proモデル）による高精度検索
   - .go.jp、.lg.jpドメインに限定（公式サイトのみ）
   - 担当部署名、電話番号、メールアドレス、フォームURL、公式ページURLを自動抽出
   - 引用番号（[1]、[2]など）を自動削除

4. **メールアドレス表示**
4. **メールアドレス表示**
   - ✅ **常に表示**（見つからない場合は案内メッセージ）
   - 見つかった場合は「メールを送信」ボタンで即座にメールアプリ起動
   - 件名と本文を自動入力（市区町村、場所、詳細情報を含む）

5. **問い合わせフォーム表示**
5. **問い合わせフォーム表示**
   - ✅ **常に表示**（見つからない場合は案内メッセージ）
   - 見つかった場合は「フォームを開く」ボタンで新しいタブで開く
   - form、inquiry、contact、otoiawase、mail などのキーワードで検出

6. **その他の連絡先**
   - 電話番号（クリックで発信可能）
   - 公式ページへのリンク
   - AI検索結果の詳細表示

## データ構造
- **検索対象**: 全国47都道府県の市区町村データ
- **使用API**: Perplexity API（sonar-proモデル）
- **ストレージ**: 不要（APIベースの検索）

## 技術スタック
- **フレームワーク**: Hono + TypeScript
- **デプロイ**: Cloudflare Pages
- **フロントエンド**: TailwindCSS + Font Awesome
- **API**: Perplexity AI

## 開発環境

### セットアップ
```bash
npm install
npm run build
pm2 start ecosystem.config.cjs
```

### デプロイ
```bash
npm run deploy
```

### 環境変数
- `PERPLEXITY_API_KEY`: Perplexity APIキー（.dev.varsに設定済み）

## ユーザーガイド

### 使い方
1. **市区町村を選択**
   - 方法1: 検索ボックスに市区町村名を入力して候補から選択（自動検索）
   - 方法2: プルダウンから都道府県→市区町村を選択（自動検索）

2. **検索結果を確認**
   - 担当部署名（都道府県・市町村名付き）
   - 電話番号（クリックで発信）
   - メールアドレス（クリックでメール送信）
   - 問い合わせフォーム（クリックでフォームを開く）
   - 公式ページ（市町村名付きリンク）

3. **検索履歴タブ** ⭐NEW
   - 最新5件の検索結果がタブで表示されます
   - タブをクリックすると過去の検索結果にすぐ戻れます
   - ブラウザを閉じても履歴は保存されます

### メール送信機能
- 「メールを送信」ボタンをクリックすると、メールアプリが起動します
- 件名と本文は自動入力されます
- 本文には以下が含まれます：
  - 市区町村
  - 担当部署

### 問い合わせフォーム機能
- 「フォームを開く」ボタンをクリックすると、新しいタブで開きます
- 自治体の公式問い合わせフォームに直接アクセスできます

## デプロイ状況
- **プラットフォーム**: Cloudflare Pages（準備中）
- **ステータス**: ❌ 未デプロイ（開発環境のみ）
- **最終更新**: 2026-01-23

## 改善履歴

### 2026-01-23
- ✅ 担当部署の前に都道府県・市町村名を表示（例: 「埼玉県本庄市 環境課・公害対策課」）
- ✅ AIレスポンスのMarkdown太字記号（`**`）を自動削除
- ✅ AIレスポンスの引用番号（`[1]`、`[2]`など）を自動削除
- ✅ 「公式ページを開く」ボタンに市町村名を追加（例: 「横浜市の公式ページを開く」）
- ✅ 「AI検索結果の詳細を見る」セクションを削除（UIをシンプル化）
- ✅ 検索ボタンを削除し、候補選択時・プルダウン選択時に自動検索
- ✅ 検索履歴タブ機能を追加（最大5件、localStorageで永続化）

### 2026-01-16
- ✅ メールアドレスを常に表示（見つからない場合は案内メッセージ）
- ✅ 問い合わせフォームを常に表示（見つからない場合は案内メッセージ）
- ✅ メール送信ボタンに件名と本文の自動入力機能を追加
- ✅ フォーム検出パターンを拡張（mail、soudan、mail_form など）
- ✅ UI改善（ボタンスタイル、説明文追加）
- ✅ Perplexityプロンプトを改善（メールとフォームの検索精度向上）
- ✅ メールアドレス検出を改善（ページ下部の「お問合せ」セクションを重点的に検索）
- ✅ メールリンクを直接デフォルトメーラーを起動するように変更（ブラウザ経由なし）
- ✅ max_tokens を 1200 に増加（より詳細な検索結果）
- ✅ 公式ドメイン（.lg.jp、.go.jp）のメールアドレスを優先
- ✅ プロンプトを改善：メールアドレスを積極的に探すように指示を強化
- ✅ 建物・場所の情報と詳細情報のフォームフィールドを削除（シンプル化）

## 今後の開発予定
- [ ] Cloudflare Pagesへの本番デプロイ
- [ ] FAX番号の表示
- [ ] タブの並び替え機能
- [ ] タブの削除機能
